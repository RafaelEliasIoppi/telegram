package telegram.teste.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;

@Component
public class DefesaCivilMonitor {

    @Autowired
    private TelegramService telegramService;

    private final RestTemplate restTemplate = new RestTemplate();

    // URL oficial da Defesa Civil RS (avisos e boletins)
    private static final String DEFESA_CIVIL_URL =
            "https://www.defesacivil.rs.gov.br/avisos"; // ajuste conforme endpoint real

    private String ultimoAviso = "";

    /**
     * Verifica a cada 10 minutos se há novos alertas na Defesa Civil RS.
     */
    @Scheduled(fixedRate = 600000) // 600.000 ms = 10 minutos
    public void verificarAlertas() {
        try {
            String conteudo = restTemplate.getForObject(DEFESA_CIVIL_URL, String.class);

            String avisoAtual = extrairAviso(conteudo);

            if (!avisoAtual.isEmpty() && !avisoAtual.equals(ultimoAviso)) {
                ultimoAviso = avisoAtual;
                telegramService.sendMessage("⚠️ Alerta da Defesa Civil RS:\n" + avisoAtual);
            }

        } catch (Exception e) {
            System.err.println("Erro ao consultar Defesa Civil RS: " + e.getMessage());
        }
    }

    /**
     * Extrai o aviso mais recente usando Jsoup.
     */
    private String extrairAviso(String html) {
        if (html == null || html.isEmpty()) return "";

        try {
            Document doc = Jsoup.parse(html);

            // Exemplo: pegar o primeiro título ou parágrafo da seção de avisos
            Element aviso = doc.selectFirst(".avisos, .aviso, .news-item, p, h2, h3"); 
            if (aviso != null) {
                return aviso.text();
            }
        } catch (Exception e) {
            System.err.println("Erro ao parsear HTML: " + e.getMessage());
        }

        return "";
    }
}
