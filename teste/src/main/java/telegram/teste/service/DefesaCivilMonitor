package telegram.teste.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

@Component
public class DefesaCivilMonitor {

    @Autowired
    private TelegramService telegramService;

    private final RestTemplate restTemplate = new RestTemplate();

    // URL oficial da Defesa Civil RS (avisos e boletins)
    private static final String DEFESA_CIVIL_URL =
            "https://www.defesacivil.rs.gov.br/avisos"; // ajuste conforme endpoint real

    private String ultimoAviso = "";

    /**
     * Verifica a cada 10 minutos se há novos alertas na Defesa Civil RS.
     */
    @Scheduled(fixedRate = 600000) // 600.000 ms = 10 minutos
    public void verificarAlertas() {
        try {
            String conteudo = restTemplate.getForObject(DEFESA_CIVIL_URL, String.class);

            // Aqui você pode usar regex ou parser HTML para extrair o aviso mais recente
            String avisoAtual = extrairAviso(conteudo);

            if (!avisoAtual.isEmpty() && !avisoAtual.equals(ultimoAviso)) {
                ultimoAviso = avisoAtual;
                telegramService.sendMessage("⚠️ Alerta da Defesa Civil RS:\n" + avisoAtual);
            }

        } catch (Exception e) {
            System.err.println("Erro ao consultar Defesa Civil RS: " + e.getMessage());
        }
    }

    /**
     * Método simples para extrair aviso do HTML retornado.
     * Em produção, use Jsoup ou outro parser para maior precisão.
     */
    private String extrairAviso(String html) {
        if (html == null) return "";
        // Exemplo simplificado: procurar palavra-chave
        int idx = html.indexOf("Aviso");
        if (idx > 0) {
            return html.substring(idx, Math.min(idx + 200, html.length()));
        }
        return "";
    }
}
